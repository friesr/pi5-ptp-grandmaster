{% extends "base.html" %}
{% block content %}

<!-- Header -->
<div class="card">
    <h2>
        <img class="card-icon" src="/static/icons/desktop/alerts.svg">
        Operator Activity Log
    </h2>
    <p>
        A chronological record of operator actions, system events, Digital Twin jobs, exports,
        service restarts, and scenario operations. Updated in real time.
    </p>
</div>

<!-- Filters -->
<div class="card">
    <h2>Filters</h2>

    <div class="flex-row">
        <div class="flex-1">
            <label>Event Type</label>
            <select id="type-filter" onchange="loadLog()">
                <option value="ALL">All</option>
                <option value="ACTION">Operator Action</option>
                <option value="EXPORT">Export</option>
                <option value="SIMULATION">Digital Twin</option>
                <option value="SCENARIO">Scenario</option>
                <option value="SERVICE">Service</option>
                <option value="ALERT">Alert</option>
                <option value="SYSTEM">System</option>
            </select>
        </div>

        <div class="flex-1">
            <label>Severity</label>
            <select id="severity-filter" onchange="loadLog()">
                <option value="ALL">All</option>
                <option value="INFO">Info</option>
                <option value="WARN">Warning</option>
                <option value="ERROR">Error</option>
            </select>
        </div>

        <div class="flex-1">
            <label>Time Range</label>
            <select id="time-filter" onchange="loadLog()">
                <option value="1h">Last Hour</option>
                <option value="6h">Last 6 Hours</option>
                <option value="24h">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="all">All</option>
            </select>
        </div>
    </div>
</div>

<!-- Activity Log -->
<div class="card">
    <h2>Activity Log</h2>
    <div id="log-list">Loadingâ€¦</div>
</div>

<script>
function loadLog() {
    const params = {
        type: document.getElementById('type-filter').value,
        severity: document.getElementById('severity-filter').value,
        time: document.getElementById('time-filter').value
    };

    fetch('/api/activity_log', {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(params)
    })
    .then(r => r.json())
    .then(d => {
        const list = d.entries || [];
        const div = document.getElementById('log-list');

        if (list.length === 0) {
            div.innerHTML = "<p>No activity in this time range.</p>";
            return;
        }

        div.innerHTML = list.map(e => `
            <div class="alert-row ${severityClass(e.severity)}">
                <div style="font-weight:600;">${e.title}</div>
                <div>${e.message}</div>
                <div class="alert-meta">${e.time}</div>
            </div>
        `).join('');
    });
}

function severityClass(s) {
    return s === "ERROR" ? "alert-critical" :
           s === "WARN"  ? "alert-major" :
                           "alert-minor";
}

setInterval(loadLog, 5000);
loadLog();
</script>

{% endblock %}

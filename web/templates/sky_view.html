{% extends "base.html" %}
{% block content %}

<!-- Header -->
<div class="card">
    <h2>
        <img class="card-icon" src="/static/icons/desktop/gnss.svg">
        Constellation Sky View
    </h2>
    <p>
        Real‑time sky‑ring visualization of all tracked and visible satellites. Shows azimuth,
        elevation, SNR, and constellation grouping.
    </p>
</div>

<!-- Sky Plot -->
<div class="card">
    <h2>Sky Plot</h2>
    <div id="skyplot-container" style="width:100%; height:600px; position:relative;">
        <svg id="skyplot" width="100%" height="100%" viewBox="0 0 500 500"></svg>
    </div>
</div>

<!-- Legend -->
<div class="card">
    <h2>Legend</h2>
    <div style="display:flex; gap:20px; flex-wrap:wrap;">
        <span class="badge" style="background:#3498db;">GPS</span>
        <span class="badge" style="background:#e67e22;">GLONASS</span>
        <span class="badge" style="background:#9b59b6;">Galileo</span>
        <span class="badge" style="background:#2ecc71;">BeiDou</span>
        <span class="badge" style="background:#f1c40f; color:#000;">QZSS</span>
        <span class="badge" style="background:#95a5a6;">SBAS</span>
    </div>
</div>

<script>
function renderSkyplot(sats) {
    const svg = document.getElementById("skyplot");
    svg.innerHTML = "";

    const cx = 250;
    const cy = 250;
    const r = 220;

    // Draw elevation rings
    const rings = [0, 30, 60, 90];
    rings.forEach(elev => {
        const rr = r * (1 - elev / 90);
        svg.innerHTML += `
            <circle cx="${cx}" cy="${cy}" r="${rr}"
                stroke="var(--border)" stroke-width="1" fill="none" />
        `;
    });

    // Draw azimuth spokes
    for (let a = 0; a < 360; a += 30) {
        const rad = a * Math.PI / 180;
        const x = cx + r * Math.sin(rad);
        const y = cy - r * Math.cos(rad);
        svg.innerHTML += `
            <line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}"
                stroke="var(--border)" stroke-width="1" />
        `;
    }

    // Draw satellites
    sats.forEach(s => {
        const az = s.azimuth * Math.PI / 180;
        const rr = r * (1 - s.elevation / 90);

        const x = cx + rr * Math.sin(az);
        const y = cy - rr * Math.cos(az);

        const color =
            s.constellation === "GPS" ? "#3498db" :
            s.constellation === "GLONASS" ? "#e67e22" :
            s.constellation === "Galileo" ? "#9b59b6" :
            s.constellation === "BeiDou" ? "#2ecc71" :
            s.constellation === "QZSS" ? "#f1c40f" :
            "#95a5a6";

        const locked = s.locked ? "stroke-width:3" : "stroke-width:1";

        svg.innerHTML += `
            <circle cx="${x}" cy="${y}" r="10"
                fill="${color}"
                stroke="var(--text)"
                ${locked}
                opacity="${s.snr ? Math.min(1, s.snr / 50) : 0.6}">
            </circle>

            <text x="${x}" y="${y + 4}" text-anchor="middle"
                font-size="10" fill="var(--text)">
                ${s.prn}
            </text>
        `;
    });
}

function loadSkyplot() {
    fetch('/api/gnss/skyplot')
        .then(r => r.json())
        .then(d => renderSkyplot(d.satellites || []));
}

setInterval(loadSkyplot, 5000);
loadSkyplot();
</script>

{% endblock %}

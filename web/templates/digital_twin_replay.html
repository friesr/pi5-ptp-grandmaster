{% extends "base.html" %}
{% block content %}

<!-- Replay Studio Header -->
<div class="card">
    <h2>
        <img class="card-icon" src="/static/icons/desktop/dashboard.svg">
        Digital Twin — Replay Studio
    </h2>
    <p>
        Replay historical GNSS, PTP, interference, and system events with synchronized timing.
        This tool reconstructs timing behavior to support root‑cause analysis and scenario exploration.
    </p>
</div>

<!-- Replay Controls -->
<div class="card">
    <h2>Replay Controls</h2>

    <div style="display:flex; gap:20px; align-items:center;">
        <div>
            <label>Start Time</label><br>
            <input id="start" type="datetime-local">
        </div>

        <div>
            <label>End Time</label><br>
            <input id="end" type="datetime-local">
        </div>

        <div>
            <label>Speed</label><br>
            <select id="speed">
                <option value="1">1×</option>
                <option value="2">2×</option>
                <option value="5">5×</option>
                <option value="10">10×</option>
            </select>
        </div>

        <button class="save-button" onclick="startReplay()">Start Replay</button>
    </div>
</div>

<!-- Replay Output -->
<div class="card">
    <h2>Replay Output</h2>
    <div id="replay-status">Waiting for replay…</div>

    <div style="display:flex; gap:20px; margin-top:20px;">

        <div style="flex:1;">
            <h3>GNSS</h3>
            <div id="gnss"></div>
            <div id="gnss-spark"></div>
        </div>

        <div style="flex:1;">
            <h3>PTP</h3>
            <div id="ptp"></div>
            <div id="ptp-spark"></div>
        </div>

    </div>

    <div style="display:flex; gap:20px; margin-top:20px;">

        <div style="flex:1;">
            <h3>Interference</h3>
            <div id="interference"></div>
            <div id="interference-heat"></div>
        </div>

        <div style="flex:1;">
            <h3>Confidence</h3>
            <div id="confidence"></div>
            <div id="confidence-spark"></div>
        </div>

    </div>
</div>

<script src="/static/js/mobile_viz.js"></script>

<script>
let replayInterval = null;

function startReplay() {
    const start = document.getElementById('start').value;
    const end   = document.getElementById('end').value;
    const speed = document.getElementById('speed').value;

    if (!start || !end) {
        alert("Please select a start and end time");
        return;
    }

    if (replayInterval) clearInterval(replayInterval);

    document.getElementById('replay-status').innerHTML =
        `<span class="badge badge-info">Replaying from ${start} to ${end} at ${speed}×</span>`;

    replayInterval = setInterval(() => {
        fetch(`/api/digital_twin/replay?start=${start}&end=${end}&speed=${speed}`)
            .then(r => r.json())
            .then(d => {

                // GNSS
                document.getElementById('gnss').innerHTML =
                    `<span class="badge ${d.gnss.locked > 0 ? 'badge-ok' : 'badge-bad'}">
                        ${d.gnss.locked} locked
                     </span>`;
                renderSparkline("gnss-spark", d.gnss.history || [], "minimal");

                // PTP
                document.getElementById('ptp').innerHTML =
                    `<span class="badge ${Math.abs(d.ptp.offset) > 500 ? 'badge-bad' : Math.abs(d.ptp.offset) > 200 ? 'badge-warn' : 'badge-ok'}">
                        Offset: ${d.ptp.offset} ns
                     </span>`;
                renderSparkline("ptp-spark", d.ptp.offset_history || [], "minimal");

                // Interference
                document.getElementById('interference').innerHTML =
                    `<span class="badge ${d.interference.level === 'LOW' ? 'badge-ok' : 'badge-bad'}">
                        Level: ${d.interference.level}
                     </span>`;
                renderMiniHeatmap("interference-heat", d.interference.samples || []);

                // Confidence
                document.getElementById('confidence').innerHTML =
                    `<span class="badge badge-info">Score: ${d.confidence.score}</span>`;
                renderSparkline("confidence-spark", d.confidence.history || [], "minimal");
            });
    }, 1000);
}
</script>

{% endblock %}

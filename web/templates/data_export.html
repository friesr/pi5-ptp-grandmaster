{% extends "base.html" %}
{% block content %}

<!-- Header -->
<div class="card">
    <h2>
        <img class="card-icon" src="/static/icons/desktop/config.svg">
        Data Export Center
    </h2>
    <p>
        Export GNSS, PTP, system health, event timelines, Digital Twin artifacts, and diagnostic
        bundles. All exports are generated on demand and downloaded immediately.
    </p>
</div>

<!-- GNSS Export -->
<div class="card">
    <h2>GNSS Data</h2>

    <div class="flex-row">
        <button class="save-button" onclick="exportData('/api/export/gnss/history')">
            GNSS History (CSV)
        </button>

        <button class="save-button" onclick="exportData('/api/export/gnss/constellation')">
            Constellation Snapshot (JSON)
        </button>

        <button class="save-button" onclick="exportData('/api/export/gnss/replay_bundle')">
            Replay Bundle
        </button>
    </div>
</div>

<!-- PTP Export -->
<div class="card">
    <h2>PTP Data</h2>

    <div class="flex-row">
        <button class="save-button" onclick="exportData('/api/export/ptp/offset_history')">
            Offset History (CSV)
        </button>

        <button class="save-button" onclick="exportData('/api/export/ptp/jitter_history')">
            Jitter History (CSV)
        </button>

        <button class="save-button" onclick="exportData('/api/export/ptp/replay_bundle')">
            Replay Bundle
        </button>
    </div>
</div>

<!-- System Health -->
<div class="card">
    <h2>System Health</h2>

    <div class="flex-row">
        <button class="save-button" onclick="exportData('/api/export/system/health_snapshot')">
            Health Snapshot (JSON)
        </button>

        <button class="save-button" onclick="exportData('/api/export/system/health_history')">
            Health History (CSV)
        </button>

        <button class="save-button" onclick="exportData('/api/export/system/diagnostics')">
            Full Diagnostics Bundle
        </button>
    </div>
</div>

<!-- Event Timeline -->
<div class="card">
    <h2>Event Timeline</h2>

    <div class="flex-row">
        <button class="save-button" onclick="exportData('/api/export/events/timeline')">
            Timeline (CSV)
        </button>

        <button class="save-button" onclick="exportData('/api/export/events/timeline_json')">
            Timeline (JSON)
        </button>
    </div>
</div>

<!-- Digital Twin -->
<div class="card">
    <h2>Digital Twin</h2>

    <div class="flex-row">
        <button class="save-button" onclick="exportData('/api/export/dt/scenarios')">
            Scenario Library (JSON)
        </button>

        <button class="save-button" onclick="exportData('/api/export/dt/montecarlo')">
            Monte Carlo Results (CSV)
        </button>

        <button class="save-button" onclick="exportData('/api/export/dt/risk_curves')">
            Risk Curves (CSV)
        </button>
    </div>
</div>

<!-- Status -->
<div class="card">
    <h2>Export Status</h2>
    <div id="status">No exports yet.</div>
</div>

<script>
function exportData(url) {
    document.getElementById('status').innerHTML =
        `<span class="badge badge-info">Preparing exportâ€¦</span>`;

    fetch(url)
        .then(r => {
            if (!r.ok) throw new Error("Export failed");
            return r.blob();
        })
        .then(blob => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);

            const filename = url.split('/').pop() + '_' + Date.now();
            a.download = filename;

            a.click();
            URL.revokeObjectURL(a.href);

            document.getElementById('status').innerHTML =
                `<span class="badge badge-ok">Export complete</span>`;
        })
        .catch(() => {
            document.getElementById('status').innerHTML =
                `<span class="badge badge-bad">Export failed</span>`;
        });
}
</script>

{% endblock %}

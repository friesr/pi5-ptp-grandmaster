{% extends "base.html" %}
{% block content %}

<!-- Header -->
<div class="card">
    <h2>
        <img class="card-icon" src="/static/icons/desktop/gnss.svg">
        GNSS Clock Stability Analyzer
    </h2>
    <p>
        Analyze per‑satellite clock stability using Allan deviation, drift rate, and frequency error.
        Updated in real time from the GNSS receiver and timing engine.
    </p>
</div>

<!-- Satellite Selector -->
<div class="card">
    <h2>Select Satellite</h2>
    <select id="sat-select" onchange="loadClockData()">
        <option value="">Loading…</option>
    </select>
</div>

<!-- Current Metrics -->
<div class="card">
    <h2>Current Clock Metrics</h2>

    <div class="flex-row">
        <div class="flex-1">
            <h3>Clock Drift</h3>
            <div id="drift" class="badge badge-info"></div>
        </div>

        <div class="flex-1">
            <h3>Frequency Error</h3>
            <div id="freq" class="badge badge-info"></div>
        </div>

        <div class="flex-1">
            <h3>Stability Class</h3>
            <div id="stability" class="badge badge-info"></div>
        </div>
    </div>
</div>

<!-- Allan Deviation Plot -->
<div class="card">
    <h2>Allan Deviation</h2>
    <p>
        Shows short‑term and long‑term stability. Lower values indicate a more stable satellite clock.
    </p>
    <div id="adev-spark"></div>
</div>

<!-- Drift Trend -->
<div class="card">
    <h2>Clock Drift Trend</h2>
    <div id="drift-spark"></div>
</div>

<!-- Frequency Error Trend -->
<div class="card">
    <h2>Frequency Error Trend</h2>
    <div id="freq-spark"></div>
</div>

<script src="/static/js/mobile_viz.js"></script>

<script>
function loadSatelliteList() {
    fetch('/api/gnss/satellite_list')
        .then(r => r.json())
        .then(d => {
            const sel = document.getElementById('sat-select');
            sel.innerHTML = "";

            d.satellites.forEach(s => {
                sel.innerHTML += `<option value="${s.prn}">${s.prn} (${s.constellation})</option>`;
            });

            loadClockData();
        });
}

function loadClockData() {
    const prn = document.getElementById('sat-select').value;
    if (!prn) return;

    fetch(`/api/gnss/clock_stability?prn=${prn}`)
        .then(r => r.json())
        .then(d => {
            document.getElementById('drift').innerText = d.clock_drift + " ns/s";
            document.getElementById('freq').innerText = d.frequency_error + " ppb";
            document.getElementById('stability').innerText = d.stability_class;

            renderSparkline("adev-spark", d.allan_deviation || [], "minimal");
            renderSparkline("drift-spark", d.drift_trend || [], "minimal");
            renderSparkline("freq-spark", d.freq_trend || [], "minimal");
        });
}

loadSatelliteList();
setInterval(loadClockData, 5000);
</script>

{% endblock %}

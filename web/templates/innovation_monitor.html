{% extends "base.html" %}
{% block content %}

<!-- Header -->
<div class="card">
    <h2>
        <img class="card-icon" src="/static/icons/desktop/gnss.svg">
        GNSS Measurement Innovation Monitor
    </h2>
    <p>
        Visualize Kalman filter innovation terms, NIS values, covariance behavior, and
        innovation‑driven anomaly detection across all satellites and constellations.
    </p>
</div>

<!-- Satellite Selector -->
<div class="card">
    <h2>Select Satellite</h2>
    <select id="sat-select" onchange="loadInnovation()">
        <option value="">Loading…</option>
    </select>
</div>

<!-- Summary -->
<div class="card">
    <h2>Innovation Summary</h2>
    <div id="summary">Loading…</div>
</div>

<!-- Innovation Trend -->
<div class="card">
    <h2>Innovation Trend</h2>
    <div id="innov-spark"></div>
</div>

<!-- NIS Trend -->
<div class="card">
    <h2>Normalized Innovation Squared (NIS)</h2>
    <div id="nis-spark"></div>
</div>

<!-- Covariance Trend -->
<div class="card">
    <h2>Innovation Covariance</h2>
    <div id="cov-spark"></div>
</div>

<!-- Chi‑Square Test -->
<div class="card">
    <h2>Chi‑Square Consistency Test</h2>
    <div id="chisq">Loading…</div>
</div>

<!-- Events -->
<div class="card">
    <h2>Innovation‑Driven Events</h2>
    <div id="events">No events yet.</div>
</div>

<script src="/static/js/mobile_viz.js"></script>

<script>
function loadSatelliteList() {
    fetch('/api/gnss/satellite_list')
        .then(r => r.json())
        .then(d => {
            const sel = document.getElementById('sat-select');
            sel.innerHTML = "";

            d.satellites.forEach(s => {
                sel.innerHTML += `<option value="${s.prn}">${s.prn} (${s.constellation})</option>`;
            });

            loadInnovation();
        });
}

function loadInnovation() {
    const prn = document.getElementById('sat-select').value;
    if (!prn) return;

    fetch(`/api/gnss/innovation?prn=${prn}`)
        .then(r => r.json())
        .then(d => {
            // Summary
            document.getElementById('summary').innerHTML = `
                <p><strong>Mean Innovation:</strong> ${d.mean} m</p>
                <p><strong>Innovation StdDev:</strong> ${d.std}</p>
                <p><strong>NIS Mean:</strong> ${d.nis_mean}</p>
                <p><strong>Notes:</strong> ${d.notes}</p>
            `;

            // Trends
            renderSparkline("innov-spark", d.innovation || [], "minimal");
            renderSparkline("nis-spark", d.nis || [], "minimal");
            renderSparkline("cov-spark", d.covariance || [], "minimal");

            // Chi‑square
            document.getElementById('chisq').innerHTML = `
                <p><strong>Chi‑Square Value:</strong> ${d.chisq.value}</p>
                <p><strong>Threshold:</strong> ${d.chisq.threshold}</p>
                <p><strong>Status:</strong> ${d.chisq.pass ? "PASS" : "FAIL"}</p>
            `;

            // Events
            const events = d.events || [];
            const eDiv = document.getElementById('events');

            if (events.length === 0) {
                eDiv.innerHTML = "<p>No innovation‑driven events detected.</p>";
            } else {
                eDiv.innerHTML = events.map(ev => `
                    <div class="alert-row ${severityClass(ev.severity)}">
                        <div style="font-weight:600;">${ev.title}</div>
                        <div>${ev.description}</div>
                        <div class="alert-meta">${ev.time}</div>
                    </div>
                `).join('');
            }
        });
}

function severityClass(s) {
    return s === "CRITICAL" ? "alert-critical" :
           s === "MAJOR"    ? "alert-major" :
                              "alert-minor";
}

loadSatelliteList();
setInterval(loadInnovation, 5000);
</script>

{% endblock %}
